## New: automatic `holes_connected.geojson`

- When `holes_geofenced.geojson` is generated, the system also writes `holes_connected.geojson` under the same `generated/` directory.
- The connected file builds a single continuous path: clubhouse → holes 1..18 (from `holes.geojson`) → clubhouse, using the clubhouse from `config/simulation_config.json`.
- It includes exactly N minute nodes, where N = `golfer_18_holes_minutes` in `simulation_config.json`.
- Default output path: `courses/<course>/geojson/generated/holes_connected.geojson`.

Quick run (PowerShell):
```powershell
python scripts/course_prep/geofence_holes.py --boundary courses/pinetree_country_club/geojson/course_polygon.geojson --holes courses/pinetree_country_club/geojson/holes.geojson
```

Note: Running `scripts/routing/extract_course_data.py` also triggers both outputs automatically when geofencing is enabled.

## Simplified cart network builder — holes_connected

Build a simplified cart-path network directly from `geojson/generated/holes_connected.geojson` (indexed points along the full loop). This is fast and ideal for high-level routing where detailed cart path splits are unnecessary.

### Usage (PowerShell)

```powershell
python scripts/routing/build_cart_network_from_holes_connected.py courses/pinetree_country_club --save-png outputs/cart_network.png
```

- **Output pickle**: `courses/pinetree_country_club/pkl/cart_graph.pkl` (default; override with `--output-name`)
- **PNG (optional)**: Saved to the path passed via `--save-png` (relative paths resolve under the course dir)

### Options

- `--no-shortcuts`: Disable adding hard-coded shortcut links
- `--no-close-loop`: Do not add the closing edge between last and first index
- `--no-clubhouse`: Do not auto-connect the clubhouse to the nearest node
- `--output-name NAME.pkl`: Output pickle filename (default: `cart_graph.pkl`)
- `--save-png PATH`: Optional PNG export path

Shortcuts, when enabled, currently include these index pairs: `233-201`, `209-191`, `40-65`, `39-67`.

## TODO
Remove `--groups-interval-min` as a user-facing option. Group interval should be determined automatically based on `golfer_18_holes_minutes`, which is the only parameter the user should set for group pacing.


## Unified Simulation Runner — `scripts/sim/run_unified_simulation.py`

Run all simulations from one entrypoint. Windows PowerShell friendly: one short command per line, no piping/chaining.

### Quick usage

```powershell
# Beverage carts GPS only (2 carts, 1 run)
python scripts/sim/run_unified_simulation.py --mode bev-carts --num-carts 2 --num-runs 1

# Beverage cart with golfers (scenario-driven groups)
python scripts/sim/run_unified_simulation.py --mode bev-with-golfers --tee-scenario typical_weekday --num-runs 1

# Golfers only (no carts/runners)
python scripts/sim/run_unified_simulation.py --mode golfers-only --groups-count 20 --first-tee 08:00 --groups-interval-min 12 --num-runs 1

# Delivery runner (1 runner, scenario groups)
python scripts/sim/run_unified_simulation.py --mode delivery-runner --tee-scenario busy_weekend --num-runners 1 --runner-speed 6.0 --sla-minutes 30 --num-runs 1

# Single golfer delivery
python scripts/sim/run_unified_simulation.py --mode single-golfer --hole 9 --runner-speed 6.0 --num-runs 1

# Optimize number of runners for SLA target
python scripts/sim/run_unified_simulation.py --mode optimize-runners --tee-scenario typical_weekday --target-on-time 0.95 --sla-minutes 30 --max-runners 6 --num-runs 5
```

### Modes

- **bev-carts**: Beverage cart GPS only (supports 1..N carts)
- **bev-with-golfers**: Single cart + golfer groups sales simulation
- **golfers-only**: Generate golfer GPS tracks only
- **delivery-runner**: Delivery runner(s) serving golfer groups
- **single-golfer**: Single golfer delivery simulation
- **optimize-runners**: Find minimal runners meeting SLA target

### Common options

- **--course-dir**: Course directory. Default: `courses/pinetree_country_club`
- **--num-runs**: Number of runs. Default: `5`
- **--output-dir**: Output directory root. Default: autogenerated per run
- **--log-level**: Log level. Default: `INFO`
- **--open-viewer**: After a single run, open the React viewer
- **--regenerate-travel-times**: Clear cached `travel_times*.json` before run

### Group scheduling

- **--groups-count**: Number of golfer groups (manual mode). Default: `0`
- **--groups-interval-min**: Interval between groups (min). Default: `15.0`
- **--first-tee**: First tee time `HH:MM`. Default: `09:00`
- **--tee-scenario**: Scenario key from `tee_times_config.json`. Use `none` to disable. Default: `typical_weekday`

### Beverage cart options

- **--num-carts**: Number of carts (bev-carts mode). Default: `1`
- **--avg-order-usd**: Average order value (bev-with-golfers, delivery-runner bev revenue). Default: `12.0`
- **--random-seed**: RNG seed for repeatable generation (where applicable)
- DEPRECATED: **--order-prob** (use `bev_cart_order_probability_per_9_holes` in `simulation_config.json`)

### Delivery runner options

- **--prep-time**: Food preparation time (min). Overrides the value in `simulation_config.json`.
- **--runner-speed**: Runner speed in m/s. Overrides the value in `simulation_config.json`.
- **--revenue-per-order**: Revenue per successful runner order (USD). Default: `25.0`
- **--sla-minutes**: SLA threshold for on-time (min). Default: `30`
- **--service-hours**: Active service hours for utilization scaling. Default: `10.0`
- **--num-runners**: Number of delivery runners. Default: `1`
- **--no-bev-cart**: Disable bev-cart pass boost and bev-cart artifacts in delivery-runner mode
- **--include-delivery-maps**: Save route map images for deliveries
- **--no-heatmap**: Skip delivery heatmap generation
- **--interactive-heatmap**: Also create interactive HTML heatmap
- DEPRECATED: **--order-prob-9** (probability now derived from `delivery_total_orders` in `simulation_config.json`)

### Optimization-only options (`--mode optimize-runners`)

- **--target-on-time**: Target on-time rate (0..1). Default: `0.99`
- **--max-runners**: Max runners to consider. Default: `6`

### Single-golfer-only options (`--mode single-golfer`)

- **--hole**: Specific hole 1-18 (random if omitted)
- **--placement**: `tee` | `mid` | `green`. Default: `mid`
- **--runner-delay**: Additional delay before runner departs (min). Default: `0.0`
- **--no-enhanced**: Do not use enhanced cart network
- **--no-coordinates**: Disable GPS coordinate tracking
- **--no-visualization**: Skip visualizations

### Tips

- Prefer scenario-driven groups via `--tee-scenario`; use manual `--groups-*` only when needed.
- Use `--open-viewer` with a single run to preview in the React app.
- For dynamic routing changes, run with `--regenerate-travel-times` after updating runner speed.

# Golf Delivery Simulation System

A comprehensive golf course delivery simulation system that models food and beverage delivery to golfers during their rounds, with GPS tracking and route optimization.

## Overview

This system simulates delivery operations on golf courses, tracking golfers' movements and optimizing delivery routes using both cart paths and street networks. It supports various tee time scenarios and provides detailed analytics and visualizations.

## Quick Start

### Prerequisites

1. **Python Environment**: Python 3.9 or higher
2. **Poetry**: This project uses Poetry for dependency management.

### Environment Setup

The project includes a `pyproject.toml` file configured for Poetry:

```bash
# Install Poetry (if not already installed)
# See https://python-poetry.org/docs/#installation
pip install poetry

# Install dependencies
poetry install

# Activate the Poetry shell
poetry shell
```

### Build Tasks

Before running simulations, you need to generate course data and routing networks. Follow these steps in order:

#### 1. Extract Course Data from OpenStreetMap

```bash
# Basic course extraction (cart paths only)
python scripts/routing/extract_course_data.py \
  --course "Pinetree Country Club" \
  --clubhouse-lat 34.0379 \
  --clubhouse-lon -84.5928 \
  --output-dir courses/pinetree_country_club

# Advanced extraction with street data for delivery shortcuts
python scripts/routing/extract_course_data.py \
  --course "Pinetree Country Club" \
  --clubhouse-lat 34.0379 \
  --clubhouse-lon -84.5928 \
  --include-streets \
  --street-buffer 750 \
  --course-buffer 100 \
  --output-dir courses/pinetree_country_club
```

**Generated Files:**
- `courses/pinetree_country_club/pkl/cart_graph.pkl` - Cart path network
- `courses/pinetree_country_club/pkl/golf_route.pkl` - Golf hole sequence
- `courses/pinetree_country_club/pkl/street_graph.pkl` - Street network (if --include-streets)
- `courses/pinetree_country_club/geojson/` - GeoJSON files for visualization

#### 2. Compute Travel Times

```bash
# Calculate travel times from clubhouse to each hole
python scripts/routing/compute_travel_times.py \
  --course-dir courses/pinetree_country_club \
  --cart-speed-mph 10.0
```

**Generated Files:**
- `courses/pinetree_country_club/travel_times.json` - Detailed travel metrics
- `courses/pinetree_country_club/travel_times_simple.json` - Summary data

#### 3. Enhance Cart Network (Optional)

```bash
# Add connectivity improvements and delivery shortcuts
python scripts/routing/enhance_cart_network.py \
  --course-dir courses/pinetree_country_club \
  --add-shortcuts \
  --save-graph
```

**Generated Files:**
- Updates `courses/pinetree_country_club/pkl/cart_graph.pkl` with enhancements

#### 4. Verify Build

```bash
# Test routing integration
python scripts/routing/test_routing_integration.py \
  --course-dir courses/pinetree_country_club

# Validate optimal course nodes
python scripts/sim/validate_optimal_nodes.py \
  --course-dir courses/pinetree_country_club
```

### Required PKL Files

The simulation system requires these pickle files in `courses/pinetree_country_club/pkl/`:

- **`cart_graph.pkl`** - Cart path network for routing (generated by extract_course_data.py)
- **`golf_route.pkl`** - Golf hole sequence route (generated by extract_course_data.py)
- **`street_graph.pkl`** - Street network for delivery shortcuts (optional, generated with --include-streets)

### Troubleshooting Build Issues

1. **Missing cart paths**: Use `--broaden` flag with extract_course_data.py to include more path types
2. **No route connectivity**: Run enhance_cart_network.py to add missing connections
3. **Import errors**: Ensure you've installed the package with `pip install -e .`

## Script Organization

The scripts are organized by function:

- **`scripts/sim/`** - Simulation entrypoints
  - `run_single_golfer.py` - Single golfer delivery simulation
  - `run_scenarios_batch.py` - Batch simulation runner
  - `run_single_golfer_simulation.py` - Thin CLI for single simulations

- **`scripts/routing/`** - Routing and network utilities
  - `compute_travel_times.py` - Calculate travel times between holes
  - `connect_clubhouse_endpoints.py` - Connect cart path endpoints to clubhouse
  - `enhance_cart_network.py` - Enhance cart path connectivity
  - `debug_route_to_node.py` - Interactive route debugging tool
  - `predict_delivery_route.py` - Delivery path prediction
  - `test_routing_integration.py` - Comprehensive routing tests

- **`scripts/viz/`** - Visualization tools  
  - `render_single_delivery_png.py` - Create delivery route visualizations
  - `view_cart_network.py` - View cart path networks

- **`scripts/analysis/`** - Analysis and reporting
  - `analyze_simulation_results.py` - Simulation result analysis

### Configuration

The system uses configuration files located in `courses/pinetree_country_club/config/`:

- **`simulation_config.json`**: Core simulation parameters including runner speed, prep times, and course details
- **`tee_times_config.json`**: Different tee time scenarios (weekday, weekend, rainy day, etc.)

## Running Simulations

### 1. Single Golfer Simulation

Run a single delivery simulation for a specific hole:

```bash
python scripts/sim/run_single_golfer.py --course-dir courses/pinetree_country_club --hole 9 --prep-time 10 --runner-speed 6.0 --save-coordinates --output-dir outputs/single_sim
```

**Parameters:**
- `--hole`: Hole number where the order is placed (1-18)
- `--prep-time`: Food preparation time in minutes (default: 10)
- `--runner-speed`: Runner speed in m/s (default: 6.0)
- `--save-coordinates`: Enable GPS tracking for golfer and runner
- `--output-dir`: Directory to save results

### 2. Scenario Batch Simulations

Run multiple simulations for the "testing_rainy_day" scenario (recommended for testing):

```bash
python scripts/sim/run_scenarios_batch.py --course-dir courses/pinetree_country_club --scenario testing_rainy_day --runs-per-scenario 5 --prep-time 10 --runner-speed 6.0 --log-level INFO
```

**Parameters:**
- `--num-sims`: Number of simulations to run (default: 5)
- `--prep-time`: Food preparation time in minutes (default: 10)
- `--runner-speed`: Runner speed in m/s (default: 6.0)
- `--output-dir`: Custom output directory (optional)

**Enhanced Folder Naming:**
When `--output-dir` is not specified, the system automatically creates descriptive folder names:
```
outputs/testing_rainy_day_{NUM_SIMS}sims_1runner_{SPEED}mps_{TIMESTAMP}/
```

**Examples:**
- `testing_rainy_day_5sims_1runner_6_0mps_20250809_123456/` (5 sims, 6.0 m/s)
- `testing_rainy_day_3sims_1runner_4_5mps_20250809_123456/` (3 sims, 4.5 m/s)
- `testing_rainy_day_10sims_1runner_8_0mps_20250809_123456/` (10 sims, 8.0 m/s)

**Speed Comparison Mode:**
Add `--speed-comparison` to run the same simulations with three different speeds:

```bash
python scripts/sim/run_scenarios_batch.py --course-dir courses/pinetree_country_club --scenario testing_rainy_day --runs-per-scenario 5 --prep-time 10 --runner-speed 2.0 --log-level INFO
python scripts/sim/run_scenarios_batch.py --course-dir courses/pinetree_country_club --scenario testing_rainy_day --runs-per-scenario 5 --prep-time 10 --runner-speed 6.0 --log-level INFO
python scripts/sim/run_scenarios_batch.py --course-dir courses/pinetree_country_club --scenario testing_rainy_day --runs-per-scenario 5 --prep-time 10 --runner-speed 10.0 --log-level INFO
```

This runs identical scenarios (same hole placements) with:
- **Slow speed**: 2.0 m/s
- **Medium speed**: 6.0 m/s  
- **Fast speed**: 10.0 m/s

**Output Structure for Speed Comparison:**
```
outputs/speed_comparison_{NUM_SIMS}sims_{TIMESTAMP}/
├── slow_speed_2.0mps/          # Slow runner results
├── medium_speed_6.0mps/        # Medium runner results  
├── fast_speed_10.0mps/         # Fast runner results
└── SPEED_COMPARISON_SUMMARY.md # Cross-speed analysis
```

**Why Rainy Day Scenario?**
- Only 4 golfers (1 group) on the course due to weather
- Simplified scenario ideal for testing and validation
- Clear delivery routes with minimal course traffic
- Faster simulation execution

### 3. Multi-Group Simulations

Run simulations with multiple golfer groups:

```bash
python scripts/sim/run_scenarios_batch.py --course-dir courses/pinetree_country_club --scenario busy_weekend --runs-per-scenario 3 --prep-time 10 --runner-speed 6.0 --log-level INFO
```

**Parameters:**
- `--groups`: Number of golfer groups (default: 5)
- `--holes`: Specific holes for orders (optional)
- `--random-holes`: Use random hole selection

## Configuration Management

### Runner Speed Settings

The runner speed is configured in `courses/pinetree_country_club/config/simulation_config.json`:

```json
{
  "delivery_runner_speed_mps": 2.68,
  ...
}
```

Note: Runner speed is specified only in meters per second via `delivery_runner_speed_mps`.

### Tee Time Scenarios

Available scenarios in `tee_times_config.json`:

- **`typical_weekday`**: Regular Wednesday (104 golfers)
- **`busy_weekend`**: Peak Saturday (180 golfers)
- **`quiet_day`**: Light play (68 golfers)
- **`